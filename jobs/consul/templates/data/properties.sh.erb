#!/usr/bin/env bash

# job template binding variables

# job name & index of this VM within cluster
# e.g. JOB_NAME=redis, JOB_INDEX=0
export NAME='<%= name %>'
export JOB_INDEX=<%= index %>
# full job name, like redis/0 or webapp/3
export JOB_FULL="$NAME/$JOB_INDEX"

export DEPLOYMENT_NAME=<%= spec.deployment %>
export DNS_ROOT=<%= spec.dns_domain_name %>

# $BIND_ADDR is the IP of the first network
export BIND_ADDR=<%= spec.networks.send(spec.networks.methods(false).first).ip %>

export CONSUL_NODE_NAME=$DEPLOYMENT_NAME-$NAME-$JOB_INDEX

# consul flags
<% if_p("consul.servers") do |servers| %>
<% end.else do %>
export SERVER="-server"
export BOOTSTRAP_SERVER="-bootstrap"
<% end %>

<% if_p("consul.bootstrap_address") do |bootstrap| %>
export JOIN="-join <%= bootstrap %>"
<% end %>

export SERVER=${SERVER:-}
export BOOTSTRAP_SERVER=${BOOTSTRAP_SERVER:-}
export JOIN=${JOIN:-}
