<% 
  require 'json'

  my_ip = spec.networks.send(properties.network).ip 
  my_host = spec.networks.send(properties.network).dns_record_name
  join_hosts = p('consul.cluster.join_hosts', nil)
  join_host = p('consul.cluster.join_host', nil)
  cluster_size = p('consul.cluster.size', nil)
  is_inital_leader = join_host && (join_host == my_host || join_host == my_ip)

  config = {
    data_dir: '/var/vcap/store/consul',
    ui_dir: '/var/vcap/packages/consul-ui',
    node_name: "#{spec.deployment}-#{name}-#{index}",
    bind_addr: '0.0.0.0',
    client_addr: '0.0.0.0',
    domain: 'consul',
    leave_on_terminate: false,
    log_level: 'INFO',
    domain: p('consul.domain', 'consul'),
    server: p('consul.server', true),
    ports: {
      dns: 53
    }
  }

  if (networks = spec.networks.methods(false)) && dns = spec.networks.send(networks.first).dns
    config[:recursor] = dns.first
  else
    config[:recursor] = '8.8.8.8'
  end

  if join_hosts
    config[:start_join] = join_hosts.reject { |host| host == my_host || host == my_ip }
  elsif join_host and cluster_size
    config[:start_join] = [join_host] unless is_inital_leader
    config[:bootstrap_expect] = cluster_size
  end
%>

<%= JSON.pretty_generate(config) %>